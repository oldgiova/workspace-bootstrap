- hosts: 127.0.0.1
  connection: local
  vars:
    asdf_tools:
      # Kubernetes tools
      - name: kubectl
        plugin: kubectl
        versions: ["1.20.5", "1.21.9", "1.22.8", "1.22.10", "1.23.14", "1.25.12", "1.26.6", "1.29.5", "1.30.1", "1.31.7"]
        default: "1.31.7"

      - name: helm
        plugin: helm
        versions: ["3.6.3", "3.9.0", "3.12.0"]
        default: "3.12.0"

      - name: stern
        plugin: stern
        versions: ["1.20.1"]
        default: "1.20.1"

      - name: kubectx
        plugin: kubectx
        versions: ["0.9.4"]
        default: "0.9.4"

      - name: eksctl
        plugin: eksctl
        versions: ["0.67.0", "0.143.0"]
        default: "0.143.0"

      - name: flux
        plugin: flux2
        versions: ["2.1.1","2.7.5"]
        default: "2.7.5"

      # Cloud CLI tools
      - name: awscli
        plugin: awscli
        versions: ["2.5.8", "2.11.15"]
        default: "2.11.15"

      - name: azurecli
        plugin: azure-cli
        versions: ["2.81.0"]
        default: "2.81.0"

      # Programming languages
      - name: python
        plugin: python
        versions: ["3.8.2", "3.7.13", "3.9.17", "3.9-dev", "pypy3.9-7.3.12", "3.10.13"]
        default: "3.9.17"

      - name: nodejs
        plugin: nodejs
        versions: ["14.16.1", "18.20.0", "22.17.0"]
        default: "22.17.0"

      - name: java
        plugin: java
        versions: ["adoptopenjdk-11.0.14+101", "adoptopenjdk-17.0.3+7"]
        default: "adoptopenjdk-17.0.3+7"

      # Build tools
      - name: bundler
        plugin: bundler
        versions: ["2.2.4"]
        default: "2.2.4"

      - name: maven
        plugin: maven
        versions: ["3.5.3"]
        default: "3.5.3"

      - name: yarn
        plugin: yarn
        versions: ["1.16.0"]
        default: "1.16.0"

      # Infrastructure as Code
      - name: terraform
        plugin: terraform
        versions: ["1.1.2", "1.1.7", "0.15.5", "1.2.1", "1.3.6", "1.3.9", "1.5.7", "1.6.4", "1.11.4", "1.9.8"]
        default: "1.9.8"

      - name: terragrunt
        plugin: terragrunt
        versions: ["0.36.3", "0.29.7", "0.77.17", "0.92.1"]
        default: "0.92.1"

      # Container and orchestration tools
      - name: kind
        plugin: kind
        versions: ["latest"]
        default: "latest"

      - name: dive
        plugin: dive
        versions: ["latest"]
        default: "latest"

      - name: minikube
        plugin: minikube
        versions: ["latest"]
        default: "latest"

      # Validation and security tools
      - name: kubeval
        plugin: kubeval
        versions: ["latest"]
        default: "latest"

      - name: kubeconform
        plugin: kubeconform
        versions: ["latest"]
        default: "latest"

      - name: kubescore
        plugin: kube-score
        versions: ["latest"]
        default: "latest"

      - name: trivy
        plugin: trivy
        versions: ["latest"]
        default: "latest"

      # kubectl plugins
      - name: krew
        plugin: krew
        versions: ["0.4.3", "0.4.4"]
        default: "0.4.3"

      - name: cmctl
        plugin: cmctl
        versions: ["1.8.2"]
        default: "1.8.2"

      # Data and configuration tools
      - name: yq
        plugin: yq
        versions: ["latest"]
        default: "latest"

      - name: mongosh
        plugin: mongosh
        versions: ["1.2.1"]
        default: "1.2.1"

      - name: rclone
        plugin: rclone
        versions: ["latest"]
        default: "latest"

      # CI/CD and development tools
      - name: github_cli
        plugin: github-cli
        versions: ["latest"]
        default: "latest"

      - name: oci
        plugin: oci
        versions: ["3.37.5"]
        default: "3.37.5"

      - name: hcloud
        plugin: hcloud
        versions: ["1.42.0"]
        default: "1.42.0"

      - name: sops
        plugin: sops
        versions: ["3.9.4"]
        default: "3.9.4"

      - name: lazygit
        plugin: lazygit
        versions: ["0.57.0"]
        default: "0.57.0"

      - name: checkov
        plugin: checkov
        versions: ["3.2.497"]
        default: "3.2.497"

  tasks:
    - name: check if asdf is installed
      stat:
        path: ~/.asdf
      register: asdf_installed
      ignore_errors: true

    - name: check installed asdf plugins
      shell: asdf plugin list
      register: asdf_plugins_installed
      ignore_errors: true
      when: asdf_installed.stat.exists

    - name: add asdf plugin for {{ item.name }}
      shell: asdf plugin add {{ item.plugin }}
      loop: "{{ asdf_tools }}"
      when:
        - asdf_installed.stat.exists
        - item.plugin not in asdf_plugins_installed.stdout
      ignore_errors: true

    - name: install {{ item.0.name }} version {{ item.1 }}
      shell: asdf install {{ item.0.plugin }} {{ item.1 }}
      loop: "{{ asdf_tools | subelements('versions') }}"
      when: asdf_installed.stat.exists
      register: asdf_install_result
      failed_when:
        - asdf_install_result.rc != 0
        - "'already installed' not in asdf_install_result.stderr"
      ignore_errors: true

    - name: set default version for {{ item.name }} to {{ item.default }}
      shell: asdf set -u {{ item.plugin }} {{ item.default }}
      loop: "{{ asdf_tools }}"
      when: asdf_installed.stat.exists
      ignore_errors: true

    - name: reshim asdf
      shell: asdf reshim
      when: asdf_installed.stat.exists
      ignore_errors: true

    - name: verify asdf plugin list
      shell: asdf plugin list
      register: asdf_plugins_final
      when: asdf_installed.stat.exists
      ignore_errors: true
